// backend/routes/coursRoutes.js

const express = require("express");
const router = express.Router();
const supabaseAdmin = require("../supabaseClient");
const authenticateToken = require("../middleware/authenticateToken");

// âœ… GET /cours : rÃ©cupÃ©rer les cours liÃ©s Ã  l'utilisateur
router.get("/", authenticateToken, async (req, res) => {
  const user = req.user;
  console.log(`ğŸ“š [GET /cours] RequÃªte de ${user.email} (${user.id})`);

  try {
    const { data, error } = await supabaseAdmin
      .from("cours")
      .select("*")
      .or(`eleve_id.eq.${user.id},prof_id.eq.${user.id}`);

    if (error) {
      console.error("âŒ Erreur rÃ©cupÃ©ration cours :", error);
      return res.status(500).json({ error: "Erreur rÃ©cupÃ©ration cours" });
    }

    console.log(`ğŸ“¦ ${data.length} cours rÃ©cupÃ©rÃ©s`);
    res.json(data);
  } catch (err) {
    console.error("âŒ Erreur serveur GET /cours :", err.message);
    res.status(500).json({ error: "Erreur serveur" });
  }
});


// âœ… POST /cours : crÃ©er un nouveau cours

// âœ… POST /cours : crÃ©er un nouveau cours
router.post("/", authenticateToken, async (req, res) => {
  console.log("âœ… [API] POST /cours appelÃ©e");

  const { date, prof_id, eleve_id } = req.body;
  const user_id = req.user.id;
  const user_email = req.user.email;

  console.log("ğŸ” Utilisateur authentifiÃ© :", user_email, `(${user_id})`);

  try {
    // VÃ©rifie que lâ€™Ã©lÃ¨ve appartient Ã  cet utilisateur
    const { data: eleveData, error: eleveError } = await supabaseAdmin
      .from("eleves")
      .select("*")
      .eq("id", eleve_id)
      .eq("created_by", user_id)
      .maybeSingle();

    if (eleveError || !eleveData) {
      console.warn("ğŸš« Ã‰lÃ¨ve non trouvÃ© ou non accessible");
      console.log("ğŸ” RÃ©sultat Supabase :", { eleveError, eleveData });
      return res.status(403).json({ error: "Ã‰lÃ¨ve non autorisÃ©" });
    }

    // âœ… GÃ©nÃ©rer un lien Jitsi alÃ©atoire
    const jitsi_url = `https://meet.jit.si/${crypto.randomUUID()}`;

    // ğŸ” Debug : afficher les donnÃ©es Ã  insÃ©rer
    console.log("ğŸ“¥ DonnÃ©es Ã  insÃ©rer dans cours :", {
      date,
      prof_id,
      eleve_id,
      jitsi_url,
      statut: 'prÃ©vu',
      created_by: user_id
    });
    console.log("ğŸ” RequÃªte vÃ©rifiÃ©e avec eleve_id =", eleve_id, "et user.id =", user.id);
    const { data: coursData, error: insertError } = await supabaseAdmin
      .from("cours")
      .insert([
        {
          date,
          prof_id,
          eleve_id,
          jitsi_url,
          statut: 'prÃ©vu',
          created_by: user_id
        }
      ])
      .select()
      .single();

    if (insertError || !coursData) {
      console.error("âŒ Insertion Ã©chouÃ©e :", insertError || "Aucune donnÃ©e insÃ©rÃ©e");
      return res.status(500).json({ error: "Erreur crÃ©ation cours ou rÃ©ponse vide" });
    }

    console.log("âœ… Nouveau cours insÃ©rÃ© :", coursData);
    res.status(201).json(coursData);
  } catch (err) {
    console.error("âŒ Erreur serveur POST /cours :", err.message);
    res.status(500).json({ error: "Erreur serveur" });
  }
});



// âœ… PUT /cours/:id : modifier un cours si crÃ©Ã© par utilisateur
router.put("/:id", authenticateToken, async (req, res) => {
  const coursId = req.params.id;
  const user_id = req.user.id;
  const updates = req.body;

  try {
    const { data, error } = await supabaseAdmin
      .from("cours")
      .update(updates)
      .eq("id", coursId)
      .eq("created_by", user_id)
      .select()
      .single();

    if (error || !data) {
      console.warn("ğŸš« Cours non trouvÃ© ou non modifiable");
      return res.status(403).json({ error: "Cours non autorisÃ© ou inexistant" });
    }

    console.log("âœï¸ Cours modifiÃ© :", data);
    res.json(data);
  } catch (err) {
    console.error("âŒ Erreur PUT /cours :", err.message);
    res.status(500).json({ error: "Erreur serveur" });
  }
});


// âœ… DELETE /cours/:id : supprimer un cours si crÃ©Ã© par utilisateur
router.delete("/:id", authenticateToken, async (req, res) => {
  const coursId = req.params.id;
  const user_id = req.user.id;

  try {
    const { data, error } = await supabaseAdmin
      .from("cours")
      .delete()
      .eq("id", coursId)
      .eq("created_by", user_id)
      .select()
      .single();

    if (error || !data) {
      console.warn("ğŸš« Cours non trouvÃ© ou non supprimable");
      return res.status(403).json({ error: "Cours non autorisÃ© ou inexistant" });
    }

    console.log("ğŸ—‘ï¸ Cours supprimÃ© :", data);
    res.json({ message: "Cours supprimÃ©", cours: data });
  } catch (err) {
    console.error("âŒ Erreur DELETE /cours :", err.message);
    res.status(500).json({ error: "Erreur serveur" });
  }
});

module.exports = router;
